
name: Dispatch Jobs on Push to Main

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions: write-all

jobs:
  infra:
    # terraform
    name: Check Infrastructure Configuration
    uses: ./.github/workflows/infrastructure.yml
    secrets: inherit
    
  build-image:
    name: Build docker image
    uses: ./.github/workflows/container.yml
    secrets: inherit
    
  run-playbooks:
    name: Run Ansible Playbooks
    uses: ./.github/workflows/playbooks.yml
    needs: [build-image, infra]
    secrets: inherit          

  terraform-destroy:
    name: Destroy Infrastructure
    needs: [run-playbooks]
    runs-on: ubuntu-latest
    steps:
    - name: Sign in to AWS CLI
      run: |
        mkdir $HOME/.aws && \
        echo [default] >> $HOME/.aws/credentials && \
        echo aws_access_key_id = ${{secrets.AWS_ACCESS_KEY_ID}} >> $HOME/.aws/credentials && \
        echo aws_secret_access_key = ${{secrets.AWS_SECRET_ACCESS_KEY}} >> $HOME/.aws/credentials
    - run: terraform init
    - run: terraform destroy --auto-approve
    
