name: Infrastructure

on:
  workflow_call:

jobs:
  deploy-infra:
    name: Deploy infra
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Create tfvars
      run: echo '${{secrets.TFVARS}}' >> secrets.auto.tfvars
    - name: install aws-cli
      run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
          unzip awscliv2.zip && \
          ./aws/install 
    - name: Sign in to AWS CLI
      run: |
        export AWS_ACCESS_KEY_ID=${{secrets.AWS_ACCESS_KEY}} && \
        export AWS_SECRET_ACCESS_KEY=${{secrets.AWS_SECRET_KEY}}
    - name: Terraform Init
      run: terraform init
    - name: Terraform Apply
      run: terraform apply --auto-approve
